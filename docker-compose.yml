# PyFleet Docker POC - Fleet with custom network (10.10.0.0/29)
#
# Usage:
#   1. Start the dashboard: PYTHONPATH=.. python3 run_dashboard.py
#   2. Generate a token in the dashboard (Enrollment Tokens tab)
#   3. ENROLLMENT_TOKEN=xxx docker-compose up --build

networks:
  fleet_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.10.0.0/29

services:
  node-alpha:
    build:
      context: .
      dockerfile: Dockerfile.client
    hostname: node-alpha
    environment:
      - SERVER_ADDRESS=host.docker.internal:9999
      - AGENT_NAME=alpha
      - ENROLLMENT_TOKEN=${ENROLLMENT_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      fleet_net:
        ipv4_address: 10.10.0.2
    restart: on-failure:3

  node-bravo:
    build:
      context: .
      dockerfile: Dockerfile.client
    hostname: node-bravo
    environment:
      - SERVER_ADDRESS=host.docker.internal:9999
      - AGENT_NAME=bravo
      - ENROLLMENT_TOKEN=${ENROLLMENT_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      fleet_net:
        ipv4_address: 10.10.0.3
    restart: on-failure:3

  node-charlie:
    build:
      context: .
      dockerfile: Dockerfile.client
    hostname: node-charlie
    environment:
      - SERVER_ADDRESS=host.docker.internal:9999
      - AGENT_NAME=charlie
      - ENROLLMENT_TOKEN=${ENROLLMENT_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      fleet_net:
        ipv4_address: 10.10.0.4
    restart: on-failure:3

  node-delta:
    build:
      context: .
      dockerfile: Dockerfile.client
    hostname: node-delta
    environment:
      - SERVER_ADDRESS=host.docker.internal:9999
      - AGENT_NAME=delta
      - ENROLLMENT_TOKEN=${ENROLLMENT_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      fleet_net:
        ipv4_address: 10.10.0.5
    restart: on-failure:3

  node-echo:
    build:
      context: .
      dockerfile: Dockerfile.client
    hostname: node-echo
    environment:
      - SERVER_ADDRESS=host.docker.internal:9999
      - AGENT_NAME=echo
      - ENROLLMENT_TOKEN=${ENROLLMENT_TOKEN:-}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      fleet_net:
        ipv4_address: 10.10.0.6
    restart: on-failure:3
